version: '3.8'
networks:
  redpanda_network:
    driver: bridge
volumes:
  redpanda-0: null

services:
  mongo:
    image: mongo
    restart: always
    hostname: mongo

  queue:
    image: vectorized/redpanda:latest
    command:
      - redpanda start
      - --overprovisioned
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --node-id 0
      - --check=false
    ports:
      - "19092:9092"
    volumes:
      - "./queue:/var/lib/redpanda/data"

  builder:
    depends_on: [ mongo, queue ]
    build:
      context: "../../.."
      dockerfile: "docker/gridql/Dockerfile"
    hostname: builder
    volumes:
      - "./config:/app/config"
    environment:
      MONGO_URI: mongodb://mongo:27017
      KAFKA_URI: queue:9092

  test:
    depends_on: [mongo]
    build:
      context: "../../.."
      dockerfile: "docker/gridql/Dockerfile"
    ports:
      - "3033:3033"
    volumes:
      - "./service:/app/config"
    environment:
      MONGO_URI: mongodb://mongo:27017